# gpt_module.py
import os
import openai # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É openai, –∫–æ—Ç–æ—Ä—É—é –º—ã —Å—Ç–∞–≤–∏–ª–∏ —á–µ—Ä–µ–∑ pip. –û–Ω–∞ –Ω—É–∂–Ω–∞, —á—Ç–æ–±—ã –¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –≤ API OpenAI (–≤ –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ ‚Äî –∫ –º–æ–¥–µ–ª–∏ GPT-3.5-turbo).
openai.api_key = os.getenv("OPENAI_API_KEY")  # —Ç–µ–ø–µ—Ä—å –∫–ª—é—á –±–µ—Ä—ë—Ç—Å—è –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è

# –ù–∞—á–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞-–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (–º–æ–∂–Ω–æ –∫–∞—Å—Ç–æ–º–∏—Ç—å –ø–æ–¥ —Ç—É—Ä-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞)
SYSTEM_PROMPT = {
    "role": "system", #role: "system" ‚Äì –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä–æ–µ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
    "content": "–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –ø–æ–¥–±–æ—Ä—É —Ç—É—Ä–æ–≤. –ó–∞–¥–∞–µ—à—å —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã, –≥–æ–≤–æ—Ä–∏—à—å –Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω–æ, —Å —é–º–æ—Ä–æ–º. –ù–µ –¥–∞–µ—à—å –ª–∏—à–Ω–∏—Ö –¥–∞–Ω–Ω—ã—Ö, —Ç–æ–ª—å–∫–æ –ø–æ –¥–µ–ª—É." # –Ω–∞—à –∫–∞—Å—Ç–æ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç. –¢—ã –º–æ–∂–µ—à—å —Å—é–¥–∞ –ø–∏—Å–∞—Ç—å –≤—Å—ë, —á—Ç–æ —Ö–æ—á–µ—à—å: –æ—Ç ¬´–±—É–¥—å —Ç–æ–∫—Å–∏—á–Ω—ã–º –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º¬ª –¥–æ ¬´–≥–æ–≤–æ—Ä–∏ –∫–∞–∫ –¥–µ–¥ —Å —Ä—ã–Ω–∫–∞¬ª
}

# –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ –∫–∞–∫ —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π
def ask_gpt(messages: list) -> str: #–°–æ–∑–¥–∞—ë–º —Ñ—É–Ω–∫—Ü–∏—é ask_gpt, –∫–æ—Ç–æ—Ä–∞—è: –ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π (–≤—Å—è –∏—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞), –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫—É ‚Äî –æ—Ç–≤–µ—Ç GPT.
    if not messages or messages[0]["role"] != "system": #–ó–¥–µ—Å—å –º—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –Ω–∞—á–∞–ª–µ. –ï—Å–ª–∏ –Ω–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ (not messages) –∏–ª–∏ –≤ –ø–µ—Ä–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –Ω–µ—Ç —Ä–æ–ª–∏ system, –º—ã –≤—Å—Ç–∞–≤–ª—è–µ–º –Ω–∞—à –ø—Ä–æ–º–ø—Ç –ø–µ—Ä–≤—ã–º.
        messages.insert(0, SYSTEM_PROMPT)

    try:  #–ó–¥–µ—Å—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≥–ª–∞–≤–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ ‚Äî –∑–∞–ø—Ä–æ—Å –≤ OpenAI API. 
        response = openai.ChatCompletion.create( 
            model="gpt-4o", # model="gpt-4o" ‚Äî —É–∫–∞–∑—ã–≤–∞–µ–º, —Å –∫–∞–∫–æ–π –º–æ–¥–µ–ª—å—é —Ä–∞–±–æ—Ç–∞—Ç—å.
            messages=messages #—ç—Ç–æ –≤—Å—è –∏—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏ (user, assistant, system), –∫–æ—Ç–æ—Ä—É—é GPT –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç.
        )
        return response['choices'][0]['message']['content'] #GPT –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç response, –≥–¥–µ –µ—Å—Ç—å –æ—Ç–≤–µ—Ç—ã, –º–µ—Ç–∞–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞.
    except Exception as e: #–ï—Å–ª–∏ API –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–ª—é—á –Ω–µ —Ç–æ—Ç, –ª–∏–º–∏—Ç –∏—Å—á–µ—Ä–ø–∞–Ω, –∏–ª–∏ —Ç—ã –≤—ã–∑—ã–≤–∞–µ—à—å –±—É—Ä—é –≤ —Å–µ—Ç–∏) ‚Äî –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –æ—à–∏–±–∫—É.
        print(f"[GPT ERROR] {e}") #print(...) ‚Äî –ª–æ–≥–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –≤ –∫–æ–Ω—Å–æ–ª—å (—á—Ç–æ–±—ã —Ç—ã —É–≤–∏–¥–µ–ª, —á—Ç–æ –Ω–µ —Ç–∞–∫)
        return "–£–ø—Å, GPT —Å–ª–æ–≤–∏–ª –≥–ª—é–∫ ü§Ø" #return "–£–ø—Å..." ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –±–æ–ª–µ–µ —á–µ–ª–æ–≤–µ—á–Ω—ã–π –æ—Ç–≤–µ—Ç
